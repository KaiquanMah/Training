Another common requirement when working with time series data is to apply a function on a rolling window of data. xts provides this facility through the intuitively named zoo function rollapply().
https://www.rdocumentation.org/packages/zoo/topics/rollapply
This function takes a time series object x, a window size width, and a function FUN to apply to each rolling period. The width argument can be tricky; a number supplied to the width argument specifies the number of observations in a window. For instance, to take the rolling 10-day max of a series, you would type the following:

rollapply(x, width = 10, FUN = max, na.rm = TRUE)
Note that the above would only take the 10-day max of a series with daily observations. If the series had monthly observations, it would take the 10-month max. Also note that you can pass additional arguments (i.e. na.rm to the max function) just like you would with apply().




Using rollapply(), calculate the 3-month standard deviation of the eq_mkt series. Note that eq_mkt has monthly observations. Call your 3-month rolling standard deviation eq_sd.


# try to understand na.rm=TRUE/FALSE
#stackoverflow.com/questions/39603677/rollapply-na-rm-true-giving-0-values-instead-of-nas
>z <- zoo(c(NA, NA, NA, NA,2, 3, 4, 5, NA))
tmp <- rollapply(z, 3, sum, na.rm = TRUE, align = "right")
>tmp
 3  4  5  6  7  8  9 
 0  0  2  5  9 12  9 
 
>tmp2 <- rollapply(z, 3, sum, na.rm = FALSE, align = "right")
>tmp2
 3  4  5  6  7  8  9 
NA NA NA NA  9 12 NA 

# SO IF na.rm=TRUE => treat NAs as 0s => continue with fn applied within rollapply 

# SO IF na.rm=FALSE => treat NAs as NAs 
# => if any of the last few 'width' #s are NA => outcome/number at that position will be NA
# => ONLY if any of the last few 'width' #s ARE NOT NA => outcome/number at that position will be NON NA







# Use rollapply to calculate the rolling 3 period sd of eq_mkt
eq_sd <- rollapply(eq_mkt, width = 3, FUN = sd)

eq_sd
           Equity Market Neutral
1997-01-31                    NA
1997-02-28                    NA
1997-03-31          0.0086504335
1997-04-30          0.0055012120
1997-05-31          0.0087022985
1997-06-30          0.0035571524
1997-07-31          0.0042158431
1997-08-31          0.0116567577
1997-09-30          0.0121894763
1997-10-31          0.0092878056
1997-11-30          0.0081941036
1997-12-31          0.0027024680
1998-01-31          0.0013051181
1998-02-28          0.0041677332
1998-03-31          0.0060169206
1998-04-30          0.0056426944
1998-05-31          0.0061256292
1998-06-30          0.0020952327
1998-07-31          0.0049369356
1998-08-31          0.0107704844
1998-09-30          0.0086396373
1998-10-31          0.0094503968
1998-11-30          0.0058773577
1998-12-31          0.0080089533
1999-01-31          0.0054027771
1999-02-28          0.0093402355
1999-03-31          0.0042442117
1999-04-30          0.0045883911
1999-05-31          0.0038591882
1999-06-30          0.0041404509
1999-07-31          0.0039677870
1999-08-31          0.0036555893
1999-09-30          0.0023094011
1999-10-31          0.0016743158
1999-11-30          0.0033600595
1999-12-31          0.0066002525
2000-01-31          0.0061533189
2000-02-29          0.0091139088
2000-03-31          0.0090669730
2000-04-30          0.0061294372
2000-05-31          0.0054123316
2000-06-30          0.0062083277
2000-07-31          0.0062644500
2000-08-31          0.0076151165
2000-09-30          0.0086350063
2000-10-31          0.0093388079
2000-11-30          0.0009291573
2000-12-31          0.0067884706
2001-01-31          0.0059651767
2001-02-28          0.0042524503
2001-03-31          0.0023302360
2001-04-30          0.0023302360
2001-05-31          0.0018502252
2001-06-30          0.0034078341
2001-07-31          0.0031390020
2001-08-31          0.0041016257
2001-09-30          0.0038888730
2001-10-31          0.0035501174
2001-11-30          0.0019399313
2001-12-31          0.0001527525
2002-01-31          0.0005507571
2002-02-28          0.0039230090
2002-03-31          0.0037469988
2002-04-30          0.0042122836
2002-05-31          0.0015307950
2002-06-30          0.0027098585
2002-07-31          0.0033020196
2002-08-31          0.0041146081
2002-09-30          0.0041681331
2002-10-31          0.0030892286
2002-11-30          0.0005507571
2002-12-31          0.0042673177
2003-01-31          0.0037072002
2003-02-28          0.0037643060
2003-03-31          0.0036936883
2003-04-30          0.0008020806
2003-05-31          0.0049152823
2003-06-30          0.0043038742
2003-07-31          0.0057297469
2003-08-31          0.0022278540
2003-09-30          0.0042099089
2003-10-31          0.0042099089
2003-11-30          0.0034530180
2003-12-31          0.0037740341
2004-01-31          0.0034297716
2004-02-29          0.0029501412
2004-03-31          0.0038742741
2004-04-30          0.0076356619
2004-05-31          0.0063634372
2004-06-30          0.0067002488
2004-07-31          0.0018000000
2004-08-31          0.0026210685
2004-09-30          0.0050500825
2004-10-31          0.0053153865
2004-11-30          0.0073200638
2004-12-31          0.0072707175
2005-01-31          0.0042296572
2005-02-28          0.0013000000
2005-03-31          0.0035510562
2005-04-30          0.0055108983
2005-05-31          0.0038974351
2005-06-30          0.0056871200
2005-07-31          0.0018823744
2005-08-31          0.0010214369
2005-09-30          0.0012662280
2005-10-31          0.0044237993
2005-11-30          0.0044105933
2005-12-31          0.0036828431
2006-01-31          0.0029365513
2006-02-28          0.0035246749
2006-03-31          0.0035949038
2006-04-30          0.0031240999
2006-05-31          0.0056615663
2006-06-30          0.0050401720
2006-07-31          0.0032316147
2006-08-31          0.0038574603
2006-09-30          0.0030789609
2006-10-31          0.0038591882
2006-11-30          0.0035571524
2006-12-31          0.0021939310
2007-01-31          0.0016653328
2007-02-28          0.0028095077
2007-03-31          0.0025324560
2007-04-30          0.0026102363
2007-05-31          0.0016165808
2007-06-30          0.0022744963
2007-07-31          0.0035383612
2007-08-31          0.0092143005
2007-09-30          0.0110527523
2007-10-31          0.0140094016
2007-11-30          0.0097041228
2007-12-31          0.0093786993
2008-01-31          0.0083242617
2008-02-29          0.0119538000
2008-03-31          0.0119968051
2008-04-30          0.0085582319
2008-05-31          0.0088296848
2008-06-30          0.0049662192
2008-07-31          0.0139947609
2008-08-31          0.0158872066
2008-09-30          0.0098276820
2008-10-31          0.0121697713
2008-11-30          0.0272070457
2008-12-31          0.0328561004
2009-01-31          0.0365033332
2009-02-28          0.0062851677
2009-03-31          0.0062553977
2009-04-30          0.0033501244
2009-05-31          0.0083344666
2009-06-30          0.0081002058
2009-07-31          0.0061849279
2009-08-31          0.0018147543

























>eq_mkt
           Equity Market Neutral
1997-01-31                0.0189
1997-02-28                0.0101
1997-03-31                0.0016
1997-04-30                0.0119
1997-05-31                0.0189
1997-06-30                0.0165
1997-07-31                0.0247
1997-08-31                0.0017
1997-09-30                0.0202
1997-10-31                0.0095
1997-11-30                0.0041
1997-12-31                0.0066
1998-01-31                0.0060
1998-02-28                0.0135
1998-03-31                0.0179
1998-04-30                0.0067
1998-05-31                0.0080
1998-06-30                0.0108
1998-07-31                0.0012
1998-08-31               -0.0107
1998-09-30                0.0061
1998-10-31                0.0052
1998-11-30                0.0158
1998-12-31                0.0209
1999-01-31                0.0101
1999-02-28                0.0023
1999-03-31                0.0033
1999-04-30                0.0107
1999-05-31                0.0089
1999-06-30                0.0168
1999-07-31                0.0135
1999-08-31                0.0095
1999-09-30                0.0095
1999-10-31                0.0066
1999-11-30                0.0133
1999-12-31                0.0198
2000-01-31                0.0075
2000-02-29                0.0253
2000-03-31                0.0134
2000-04-30                0.0168
2000-05-31                0.0062
2000-06-30                0.0171
2000-07-31                0.0063
2000-08-31                0.0210
2000-09-30                0.0058
2000-10-31                0.0040
2000-11-30                0.0045
2000-12-31                0.0160
2001-01-31                0.0075
2001-02-28                0.0120
2001-03-31                0.0108
2001-04-30                0.0075
2001-05-31                0.0077
2001-06-30                0.0017
2001-07-31                0.0031
2001-08-31                0.0094
2001-09-30                0.0023
2001-10-31                0.0058
2001-11-30                0.0055
2001-12-31                0.0056
2002-01-31                0.0065
2002-02-28               -0.0007
2002-03-31                0.0047
2002-04-30                0.0076
2002-05-31                0.0053
2002-06-30                0.0022
2002-07-31               -0.0013
2002-08-31                0.0069
2002-09-30                0.0015
2002-10-31                0.0016
2002-11-30                0.0025
2002-12-31                0.0094
2003-01-31                0.0083
2003-02-28                0.0024
2003-03-31                0.0015
2003-04-30                0.0031
2003-05-31                0.0107
2003-06-30                0.0034
2003-07-31               -0.0006
2003-08-31                0.0031
2003-09-30                0.0078
2003-10-31                0.0115
2003-11-30                0.0046
2003-12-31                0.0054
2004-01-31                0.0109
2004-02-29                0.0063
2004-03-31                0.0032
2004-04-30               -0.0082
2004-05-31                0.0024
2004-06-30                0.0042
2004-07-31                0.0006
2004-08-31               -0.0009
2004-09-30                0.0085
2004-10-31               -0.0005
2004-11-30                0.0140
2004-12-31                0.0058
2005-01-31                0.0081
2005-02-28                0.0080
2005-03-31                0.0019
2005-04-30               -0.0030
2005-05-31                0.0047
2005-06-30                0.0081
2005-07-31                0.0078
2005-08-31                0.0062
2005-09-30                0.0087
2005-10-31                0.0001
2005-11-30                0.0061
2005-12-31                0.0068
2006-01-31                0.0115
2006-02-28                0.0046
2006-03-31                0.0098
2006-04-30                0.0102
2006-05-31                0.0002
2006-06-30                0.0063
2006-07-31                0.0051
2006-08-31               -0.0009
2006-09-30                0.0009
2006-10-31                0.0065
2006-11-30                0.0075
2006-12-31                0.0107
2007-01-31                0.0083
2007-02-28                0.0051
2007-03-31                0.0101
2007-04-30                0.0089
2007-05-31                0.0121
2007-06-30                0.0077
2007-07-31                0.0051
2007-08-31               -0.0094
2007-09-30                0.0123
2007-10-31                0.0168
2007-11-30               -0.0018
2007-12-31                0.0054
2008-01-31               -0.0112
2008-02-29                0.0120
2008-03-31               -0.0049
2008-04-30                0.0059
2008-05-31                0.0126
2008-06-30                0.0156
2008-07-31               -0.0100
2008-08-31               -0.0135
2008-09-30               -0.0285
2008-10-31               -0.0044
2008-11-30               -0.0587
2008-12-31                0.0005
2009-01-31                0.0079
2009-02-28               -0.0046
2009-03-31                0.0021
2009-04-30               -0.0012
2009-05-31                0.0146
2009-06-30                0.0036
2009-07-31                0.0042
2009-08-31                0.0070


