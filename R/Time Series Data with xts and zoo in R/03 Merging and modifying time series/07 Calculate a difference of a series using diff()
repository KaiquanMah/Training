Another common operation on time series, typically on those that are non-stationary, is to take a difference of the series. The number of differences to take of a series is an application of recursively calling the difference function n times.

A simple way to view a single (or "first order") difference is to see it as x(t) - x(t-k) where k is the number of lags to go back. Higher order differences are simply the reapplication of a difference to each prior result.

In R, the difference operator for xts is made available using the diff() command. This function takes two arguments of note. The first is the lag, which is the number of periods, and the second is differences, which is the order of the difference (e.g. how many times diff() is called).
https://www.rdocumentation.org/packages/xts/topics/diff.xts.

# These are the same
diff(x, differences = 2)
diff(diff(x))
In this exercise, you will reuse the AirPass data from earlier in this chapter, though this time you will use the full series from 1948 to 1960.



Construct a first order difference of AirPass by hand, using lag() and subtraction. Save this as diff_by_hand.
To verify that your result is identical to using diff(AirPass), combine and inspect the first few rows of both in your console. Use merge() and head() for this.
Get the first order 12 month difference of series AirPass. Be sure to specify both the lag and differences arguments in diff().



>AirPass
           passengers
1949-01-01        112
1949-02-01        118
1949-03-01        132
1949-04-01        129
1949-05-01        121
1949-06-01        135
1949-07-01        148
1949-08-01        148
1949-09-01        136
1949-10-01        119
1949-11-01        104
1949-12-01        118
1950-01-01        115
1950-02-01        126
1950-03-01        141
1950-04-01        135
1950-05-01        125
1950-06-01        149
1950-07-01        170
1950-08-01        170
1950-09-01        158
1950-10-01        133
1950-11-01        114
1950-12-01        140
1951-01-01        145
1951-02-01        150
1951-03-01        178
1951-04-01        163
1951-05-01        172
1951-06-01        178
1951-07-01        199
1951-08-01        199
1951-09-01        184
1951-10-01        162
1951-11-01        146
1951-12-01        166
1952-01-01        171
1952-02-01        180
1952-03-01        193
1952-04-01        181
1952-05-01        183
1952-06-01        218
1952-07-01        230
1952-08-01        242
1952-09-01        209
1952-10-01        191
1952-11-01        172
1952-12-01        194
1953-01-01        196
1953-02-01        196
1953-03-01        236
1953-04-01        235
1953-05-01        229
1953-06-01        243
1953-07-01        264
1953-08-01        272
1953-09-01        237
1953-10-01        211
1953-11-01        180
1953-12-01        201
1954-01-01        204
1954-02-01        188
1954-03-01        235
1954-04-01        227
1954-05-01        234
1954-06-01        264
1954-07-01        302
1954-08-01        293
1954-09-01        259
1954-10-01        229
1954-11-01        203
1954-12-01        229
1955-01-01        242
1955-02-01        233
1955-03-01        267
1955-04-01        269
1955-05-01        270
1955-06-01        315
1955-07-01        364
1955-08-01        347
1955-09-01        312
1955-10-01        274
1955-11-01        237
1955-12-01        278
1956-01-01        284
1956-02-01        277
1956-03-01        317
1956-04-01        313
1956-05-01        318
1956-06-01        374
1956-07-01        413
1956-08-01        405
1956-09-01        355
1956-10-01        306
1956-11-01        271
1956-12-01        306
1957-01-01        315
1957-02-01        301
1957-03-01        356
1957-04-01        348
1957-05-01        355
1957-06-01        422
1957-07-01        465
1957-08-01        467
1957-09-01        404
1957-10-01        347
1957-11-01        305
1957-12-01        336
1958-01-01        340
1958-02-01        318
1958-03-01        362
1958-04-01        348
1958-05-01        363
1958-06-01        435
1958-07-01        491
1958-08-01        505
1958-09-01        404
1958-10-01        359
1958-11-01        310
1958-12-01        337
1959-01-01        360
1959-02-01        342
1959-03-01        406
1959-04-01        396
1959-05-01        420
1959-06-01        472
1959-07-01        548
1959-08-01        559
1959-09-01        463
1959-10-01        407
1959-11-01        362
1959-12-01        405
1960-01-01        417
1960-02-01        391
1960-03-01        419
1960-04-01        461
1960-05-01        472
1960-06-01        535
1960-07-01        622
1960-08-01        606
1960-09-01        508
1960-10-01        461
1960-11-01        390
1960-12-01        432























>diff(diff(AirPass))
           passengers
1949-01-01         NA
1949-02-01         NA
1949-03-01          8
1949-04-01        -17
1949-05-01         -5
1949-06-01         22
1949-07-01         -1
1949-08-01        -13
1949-09-01        -12
1949-10-01         -5
1949-11-01          2
1949-12-01         29
1950-01-01        -17
1950-02-01         14
1950-03-01          4
1950-04-01        -21
1950-05-01         -4
1950-06-01         34
1950-07-01         -3
1950-08-01        -21
1950-09-01        -12
1950-10-01        -13
1950-11-01          6
1950-12-01         45
1951-01-01        -21
1951-02-01          0
1951-03-01         23
1951-04-01        -43
1951-05-01         24
1951-06-01         -3
1951-07-01         15
1951-08-01        -21
1951-09-01        -15
1951-10-01         -7
1951-11-01          6
1951-12-01         36
1952-01-01        -15
1952-02-01          4
1952-03-01          4
1952-04-01        -25
1952-05-01         14
1952-06-01         33
1952-07-01        -23
1952-08-01          0
1952-09-01        -45
1952-10-01         15
1952-11-01         -1
1952-12-01         41
1953-01-01        -20
1953-02-01         -2
1953-03-01         40
1953-04-01        -41
1953-05-01         -5
1953-06-01         20
1953-07-01          7
1953-08-01        -13
1953-09-01        -43
1953-10-01          9
1953-11-01         -5
1953-12-01         52
1954-01-01        -18
1954-02-01        -19
1954-03-01         63
1954-04-01        -55
1954-05-01         15
1954-06-01         23
1954-07-01          8
1954-08-01        -47
1954-09-01        -25
1954-10-01          4
1954-11-01          4
1954-12-01         52
1955-01-01        -13
1955-02-01        -22
1955-03-01         43
1955-04-01        -32
1955-05-01         -1
1955-06-01         44
1955-07-01          4
1955-08-01        -66
1955-09-01        -18
1955-10-01         -3
1955-11-01          1
1955-12-01         78
1956-01-01        -35
1956-02-01        -13
1956-03-01         47
1956-04-01        -44
1956-05-01          9
1956-06-01         51
1956-07-01        -17
1956-08-01        -47
1956-09-01        -42
1956-10-01          1
1956-11-01         14
1956-12-01         70
1957-01-01        -26
1957-02-01        -23
1957-03-01         69
1957-04-01        -63
1957-05-01         15
1957-06-01         60
1957-07-01        -24
1957-08-01        -41
1957-09-01        -65
1957-10-01          6
1957-11-01         15
1957-12-01         73
1958-01-01        -27
1958-02-01        -26
1958-03-01         66
1958-04-01        -58
1958-05-01         29
1958-06-01         57
1958-07-01        -16
1958-08-01        -42
1958-09-01       -115
1958-10-01         56
1958-11-01         -4
1958-12-01         76
1959-01-01         -4
1959-02-01        -41
1959-03-01         82
1959-04-01        -74
1959-05-01         34
1959-06-01         28
1959-07-01         24
1959-08-01        -65
1959-09-01       -107
1959-10-01         40
1959-11-01         11
1959-12-01         88
1960-01-01        -31
1960-02-01        -38
1960-03-01         54
1960-04-01         14
1960-05-01        -31
1960-06-01         52
1960-07-01         24
1960-08-01       -103
1960-09-01        -82
1960-10-01         51
1960-11-01        -24
1960-12-01        113
























>diff(AirPass, differences = 2)

           passengers
1949-01-01         NA
1949-02-01         NA
1949-03-01          8
1949-04-01        -17
1949-05-01         -5
1949-06-01         22
1949-07-01         -1
1949-08-01        -13
1949-09-01        -12
1949-10-01         -5
1949-11-01          2
1949-12-01         29
1950-01-01        -17
1950-02-01         14
1950-03-01          4
1950-04-01        -21
1950-05-01         -4
1950-06-01         34
1950-07-01         -3
1950-08-01        -21
1950-09-01        -12
1950-10-01        -13
1950-11-01          6
1950-12-01         45
1951-01-01        -21
1951-02-01          0
1951-03-01         23
1951-04-01        -43
1951-05-01         24
1951-06-01         -3
1951-07-01         15
1951-08-01        -21
1951-09-01        -15
1951-10-01         -7
1951-11-01          6
1951-12-01         36
1952-01-01        -15
1952-02-01          4
1952-03-01          4
1952-04-01        -25
1952-05-01         14
1952-06-01         33
1952-07-01        -23
1952-08-01          0
1952-09-01        -45
1952-10-01         15
1952-11-01         -1
1952-12-01         41
1953-01-01        -20
1953-02-01         -2
1953-03-01         40
1953-04-01        -41
1953-05-01         -5
1953-06-01         20
1953-07-01          7
1953-08-01        -13
1953-09-01        -43
1953-10-01          9
1953-11-01         -5
1953-12-01         52
1954-01-01        -18
1954-02-01        -19
1954-03-01         63
1954-04-01        -55
1954-05-01         15
1954-06-01         23
1954-07-01          8
1954-08-01        -47
1954-09-01        -25
1954-10-01          4
1954-11-01          4
1954-12-01         52
1955-01-01        -13
1955-02-01        -22
1955-03-01         43
1955-04-01        -32
1955-05-01         -1
1955-06-01         44
1955-07-01          4
1955-08-01        -66
1955-09-01        -18
1955-10-01         -3
1955-11-01          1
1955-12-01         78
1956-01-01        -35
1956-02-01        -13
1956-03-01         47
1956-04-01        -44
1956-05-01          9
1956-06-01         51
1956-07-01        -17
1956-08-01        -47
1956-09-01        -42
1956-10-01          1
1956-11-01         14
1956-12-01         70
1957-01-01        -26
1957-02-01        -23
1957-03-01         69
1957-04-01        -63
1957-05-01         15
1957-06-01         60
1957-07-01        -24
1957-08-01        -41
1957-09-01        -65
1957-10-01          6
1957-11-01         15
1957-12-01         73
1958-01-01        -27
1958-02-01        -26
1958-03-01         66
1958-04-01        -58
1958-05-01         29
1958-06-01         57
1958-07-01        -16
1958-08-01        -42
1958-09-01       -115
1958-10-01         56
1958-11-01         -4
1958-12-01         76
1959-01-01         -4
1959-02-01        -41
1959-03-01         82
1959-04-01        -74
1959-05-01         34
1959-06-01         28
1959-07-01         24
1959-08-01        -65
1959-09-01       -107
1959-10-01         40
1959-11-01         11
1959-12-01         88
1960-01-01        -31
1960-02-01        -38
1960-03-01         54
1960-04-01         14
1960-05-01        -31
1960-06-01         52
1960-07-01         24
1960-08-01       -103
1960-09-01        -82
1960-10-01         51
1960-11-01        -24
1960-12-01        113

























# Calculate the first difference of AirPass and assign to diff_by_hand
diff_by_hand <- AirPass - lag(AirPass)


# Use merge to compare the first parts of diff_by_hand and diff(AirPass)
merge(head(diff_by_hand), head(diff(AirPass)))
           passengers passengers.1
1949-01-01         NA           NA
1949-02-01          6            6
1949-03-01         14           14
1949-04-01         -3           -3
1949-05-01         -8           -8
1949-06-01         14           14



# Calculate the first order 12 month difference of AirPass
diff(AirPass, lag = 12, differences = 1)
           passengers
1949-01-01         NA
1949-02-01         NA
1949-03-01         NA
1949-04-01         NA
1949-05-01         NA
1949-06-01         NA
1949-07-01         NA
1949-08-01         NA
1949-09-01         NA
1949-10-01         NA
1949-11-01         NA
1949-12-01         NA
1950-01-01          3
1950-02-01          8
1950-03-01          9
1950-04-01          6
1950-05-01          4
1950-06-01         14
1950-07-01         22
1950-08-01         22
1950-09-01         22
1950-10-01         14
1950-11-01         10
1950-12-01         22
1951-01-01         30
1951-02-01         24
1951-03-01         37
1951-04-01         28
1951-05-01         47
1951-06-01         29
1951-07-01         29
1951-08-01         29
1951-09-01         26
1951-10-01         29
1951-11-01         32
1951-12-01         26
1952-01-01         26
1952-02-01         30
1952-03-01         15
1952-04-01         18
1952-05-01         11
1952-06-01         40
1952-07-01         31
1952-08-01         43
1952-09-01         25
1952-10-01         29
1952-11-01         26
1952-12-01         28
1953-01-01         25
1953-02-01         16
1953-03-01         43
1953-04-01         54
1953-05-01         46
1953-06-01         25
1953-07-01         34
1953-08-01         30
1953-09-01         28
1953-10-01         20
1953-11-01          8
1953-12-01          7
1954-01-01          8
1954-02-01         -8
1954-03-01         -1
1954-04-01         -8
1954-05-01          5
1954-06-01         21
1954-07-01         38
1954-08-01         21
1954-09-01         22
1954-10-01         18
1954-11-01         23
1954-12-01         28
1955-01-01         38
1955-02-01         45
1955-03-01         32
1955-04-01         42
1955-05-01         36
1955-06-01         51
1955-07-01         62
1955-08-01         54
1955-09-01         53
1955-10-01         45
1955-11-01         34
1955-12-01         49
1956-01-01         42
1956-02-01         44
1956-03-01         50
1956-04-01         44
1956-05-01         48
1956-06-01         59
1956-07-01         49
1956-08-01         58
1956-09-01         43
1956-10-01         32
1956-11-01         34
1956-12-01         28
1957-01-01         31
1957-02-01         24
1957-03-01         39
1957-04-01         35
1957-05-01         37
1957-06-01         48
1957-07-01         52
1957-08-01         62
1957-09-01         49
1957-10-01         41
1957-11-01         34
1957-12-01         30
1958-01-01         25
1958-02-01         17
1958-03-01          6
1958-04-01          0
1958-05-01          8
1958-06-01         13
1958-07-01         26
1958-08-01         38
1958-09-01          0
1958-10-01         12
1958-11-01          5
1958-12-01          1
1959-01-01         20
1959-02-01         24
1959-03-01         44
1959-04-01         48
1959-05-01         57
1959-06-01         37
1959-07-01         57
1959-08-01         54
1959-09-01         59
1959-10-01         48
1959-11-01         52
1959-12-01         68
1960-01-01         57
1960-02-01         49
1960-03-01         13
1960-04-01         65
1960-05-01         52
1960-06-01         63
1960-07-01         74
1960-08-01         47
1960-09-01         45
1960-10-01         54
1960-11-01         28
1960-12-01         27



































>diff_by_hand
           passengers
1949-01-01         NA
1949-02-01          6
1949-03-01         14
1949-04-01         -3
1949-05-01         -8
1949-06-01         14
1949-07-01         13
1949-08-01          0
1949-09-01        -12
1949-10-01        -17
1949-11-01        -15
1949-12-01         14
1950-01-01         -3
1950-02-01         11
1950-03-01         15
1950-04-01         -6
1950-05-01        -10
1950-06-01         24
1950-07-01         21
1950-08-01          0
1950-09-01        -12
1950-10-01        -25
1950-11-01        -19
1950-12-01         26
1951-01-01          5
1951-02-01          5
1951-03-01         28
1951-04-01        -15
1951-05-01          9
1951-06-01          6
1951-07-01         21
1951-08-01          0
1951-09-01        -15
1951-10-01        -22
1951-11-01        -16
1951-12-01         20
1952-01-01          5
1952-02-01          9
1952-03-01         13
1952-04-01        -12
1952-05-01          2
1952-06-01         35
1952-07-01         12
1952-08-01         12
1952-09-01        -33
1952-10-01        -18
1952-11-01        -19
1952-12-01         22
1953-01-01          2
1953-02-01          0
1953-03-01         40
1953-04-01         -1
1953-05-01         -6
1953-06-01         14
1953-07-01         21
1953-08-01          8
1953-09-01        -35
1953-10-01        -26
1953-11-01        -31
1953-12-01         21
1954-01-01          3
1954-02-01        -16
1954-03-01         47
1954-04-01         -8
1954-05-01          7
1954-06-01         30
1954-07-01         38
1954-08-01         -9
1954-09-01        -34
1954-10-01        -30
1954-11-01        -26
1954-12-01         26
1955-01-01         13
1955-02-01         -9
1955-03-01         34
1955-04-01          2
1955-05-01          1
1955-06-01         45
1955-07-01         49
1955-08-01        -17
1955-09-01        -35
1955-10-01        -38
1955-11-01        -37
1955-12-01         41
1956-01-01          6
1956-02-01         -7
1956-03-01         40
1956-04-01         -4
1956-05-01          5
1956-06-01         56
1956-07-01         39
1956-08-01         -8
1956-09-01        -50
1956-10-01        -49
1956-11-01        -35
1956-12-01         35
1957-01-01          9
1957-02-01        -14
1957-03-01         55
1957-04-01         -8
1957-05-01          7
1957-06-01         67
1957-07-01         43
1957-08-01          2
1957-09-01        -63
1957-10-01        -57
1957-11-01        -42
1957-12-01         31
1958-01-01          4
1958-02-01        -22
1958-03-01         44
1958-04-01        -14
1958-05-01         15
1958-06-01         72
1958-07-01         56
1958-08-01         14
1958-09-01       -101
1958-10-01        -45
1958-11-01        -49
1958-12-01         27
1959-01-01         23
1959-02-01        -18
1959-03-01         64
1959-04-01        -10
1959-05-01         24
1959-06-01         52
1959-07-01         76
1959-08-01         11
1959-09-01        -96
1959-10-01        -56
1959-11-01        -45
1959-12-01         43
1960-01-01         12
1960-02-01        -26
1960-03-01         28
1960-04-01         42
1960-05-01         11
1960-06-01         63
1960-07-01         87
1960-08-01        -16
1960-09-01        -98
1960-10-01        -47
1960-11-01        -71
1960-12-01         42



